\n# HELLDECK Refactoring & Enhancement Plan\n## \"One Engine, Best Quality\" Strategy\n\n### Overview\nComprehensive refactoring to eliminate technical debt, consolidate dual architectures, and create a single, optimized game engine. No backward compatibility - we're building the best version.\n\n---\n\n## Architecture Vision\n\n```mermaid\ngraph TB\n    A[UI Layer - Compose] --> B[ViewModels]\n    B --> C[GameEngine V2 Only]\n    C --> D[ContextualSelector Thompson Sampling]\n    C --> E[TemplateEngine V2]\n    C --> F[Augmentor with LLM]\n    E --> G[ContentRepository V2]\n    F --> G\n    G --> H[Room Database]\n    D --> H\n    \n    style C fill:#4CAF50\n    style D fill:#2196F3\n    style E fill:#FF9800\n```\n\n### Key Principles\n1. **Single Source of Truth**: One engine, one selector, one template system\n2. **Modern Kotlin**: Coroutines, Flow, StateFlow throughout\n3. **Clean Architecture**: Clear separation between UI, domain, and data layers\n4. **Testability First**: Every component designed for easy testing\n5. **Performance**: Memory-efficient, smooth animations, no jank\n\n---\n\n## Phase 1: Engine Consolidation (Critical Path)\n\n### 1.1 Delete Legacy Code\n- ✂️ Remove [`GameEngine.kt`](app/src/main/java/com/helldeck/content/engine/GameEngine.kt:1) (500 lines)\n- ✂️ Remove [`Selection.kt`](app/src/main/java/com/helldeck/content/engine/Selection.kt:1) (UCB algorithm)\n- ✂️ Remove [`ContentEngineProvider.kt`](app/src/main/java/com/helldeck/content/engine/ContentEngineProvider.kt:1)\n- ✂️ Remove [`UnifiedTemplate.kt`](app/src/main/java/com/helldeck/content/data/UnifiedTemplate.kt:1)\n- ✂️ Remove all `@Deprecated` annotations and implementations\n\n### 1.2 Rename & Consolidate\n- 📝 Rename [`GameEngineV2.kt`](app/src/main/java/com/helldeck/content/engine/GameEngineV2.kt:1) → `GameEngine.kt`\n- 📝 Rename [`ContentEngineProviderV2.kt`](app/src/main/java/com/helldeck/content/engine/ContentEngineProviderV2.kt:1) → `ContentEngineProvider.kt`\n- 📝 Update all imports and references across codebase\n\n### 1.3 Refactor TemplateEngine\n**Current Issues:**\n- Legacy slot resolution logic\n- Weak error messages\n- No validation for missing lexicons\n\n**Improvements:**\n```kotlin\n// Clean slot resolution with clear error handling\nprivate fun pickFromLex(slot: String, used: Set<String>?): String {\n    val pool = repo.wordsFor(slot)\n    if (pool.isEmpty()) {\n        throw TemplateException(\n            \"Missing lexicon for slot '$slot'. Add ${slot}.json to assets/lexicons/\"\n        )\n    }\n    // ... rest of logic\n}\n```\n\n---\n\n## Phase 2: ViewModel Decomposition\n\n### Current Problem\n[`HelldeckVm`](app/src/main/java/com/helldeck/ui/Scenes.kt:185) is 600+ lines handling:\n- Navigation (Scene enum, stack)\n- Game logic (rounds, scoring, phases)\n- Player management (roster, attendance)\n- Settings (heat, spicy mode)\n\n### Solution: Split into Focused ViewModels\n\n```kotlin\n// NavigationViewModel - 100 lines\n- Scene navigation\n- Back stack management\n- Deep linking\n\n// GameViewModel - 200 lines\n- Round lifecycle\n- Scoring & feedback\n- Game state management\n\n// PlayerViewModel - 150 lines\n- Player CRUD\n- Attendance tracking\n- Profile data\n\n// SettingsViewModel - 100 lines\n- Configuration\n- Preferences\n- Theme/accessibility\n```\n\n---\n\n## Phase 3: Scenes.kt Decomposition\n\n### Current State\n[`Scenes.kt`](app/src/main/java/com/helldeck/ui/Scenes.kt:1) = **4,405 lines** 😱\n\n### Target Structure\n```\nui/\n├── navigation/\n│   └── HelldeckNavigation.kt\n├── home/\n│   ├── HomeScene.kt\n│   └── GameTile.kt\n├── rollcall/\n│   ├── RollcallScene.kt\n│   └── RollcallPlayerCard.kt\n├── players/\n│   ├── PlayersScene.kt\n│   └── PlayerListItem.kt\n├── game/\n│   ├── RoundScene.kt\n│   ├── GameTimer.kt\n│   └── interactions/\n│       ├── AvatarVoteFlow.kt\n│       ├── ABVoteFlow.kt\n│       ├── JudgePickFlow.kt\n│       └── ...\n├── feedback/\n│   ├── FeedbackScene.kt\n│   └── FeedbackStrip.kt\n├── settings/\n│   ├── SettingsScene.kt\n│   └── SettingsSection.kt\n├── stats/\n│   ├── StatsScene.kt\n│   └── StatCard.kt\n├── profile/\n│   ├── PlayerProfileScene.kt\n│   └── ProfileStatBadge.kt\n└── rules/\n    ├── RulesSheet.kt\n    └── GameRulesScene.kt\n```\n\n**Benefits:**\n- 200-300 lines per file (manageable)\n- Feature-based organization\n- Easy to find and modify\n- Better IDE performance\n- Clearer ownership\n\n---\n\n## Phase 4: Database Optimization\n\n### Add Indices\n```kotlin\n@Entity(\n    tableName = \"template_stats\",\n    indices = [\n        Index(value = [\"templateId\"], unique = true),\n        Index(value = [\"gameId\"]),\n        Index(value = [\"lastUsed\"])\n    ]\n)\ndata class TemplateStatEntity(...)\n\n@Entity(\n    tableName = \"rounds\",\n    indices = [\n        Index(value = [\"sessionId\"]),\n        Index(value = [\"timestamp\"]),\n        Index(value = [\"templateId\", \"sessionId\"])\n    ]\n)\ndata class RoundEntity(...)\n```\n\n### Query Optimization\n- Replace `getAll()` with paginated queries\n- Use `Flow` for reactive updates\n- Add proper cascade deletes\n\n---\n\n## Phase 5: Game Balance & AI Enhancement\n\n### 5.1 Scoring Review\n**Current scoring in [`HelldeckVm`](app/src/main/java/com/helldeck/ui/Scenes.kt:514):**\n```kotlin\n// Base win: +2\n// Heat bonus: +1 (≥60%)\n// Quick laugh: +1 (<1.2s)\n// Streak: +1 to +3\n// Room trash: -2 (≥60%)\n```\n\n**Issues:**\n- Streaks too powerful (snowballing)\n- Heat threshold too low (easy to game)\n- No comeback mechanics\n\n**Proposed:**\n```kotlin\n// Base win: +2\n// Heat bonus: +1 (≥70% in spicy mode, ≥60% normal)\n// Quick laugh: +1 (<1.0s)\n// Streak: +1 max (linear, not compound)\n// Comeback bonus: +2 for last place player\n// Room trash: -3 